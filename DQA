import React, { useState, useEffect, useMemo } from 'react';
import { 
  Upload, 
  AlertTriangle, 
  TrendingUp, 
  Database, 
  Users, 
  CheckCircle2, 
  Clock, 
  BarChart3, 
  ShieldAlert, 
  ChevronRight, 
  Info, 
  History, 
  FileText, 
  Send, 
  Wand2, 
  Download, 
  Check, 
  ListFilter, 
  Activity, 
  Sparkles, 
  Zap,
  Eye,
  ShieldCheck,
  ArrowRightLeft,
  X,
  Search
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  onSnapshot, 
  query, 
  addDoc, 
  serverTimestamp 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';

// --- Firebase Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'data-quality-feedback-pro';

export default function App() {
  // --- Core State ---
  const [user, setUser] = useState(null);
  const [file, setFile] = useState(null);
  const [loading, setLoading] = useState(false);
  const [errorLog, setErrorLog] = useState([]);
  const [viewMode, setViewMode] = useState('cleaner'); 
  const [selectedSource, setSelectedSource] = useState('BI Team A');
  const [searchQuery, setSearchQuery] = useState('');
  
  // --- Remediation & Diagnostic State ---
  const [lastProcessedData, setLastProcessedData] = useState(null); 
  const [activeDiagnostics, setActiveDiagnostics] = useState([]);
  const [isFixing, setIsFixing] = useState(false);
  const [fixSuccess, setFixSuccess] = useState(false);
  const [remediationSummary, setRemediationSummary] = useState(null);
  const [showPreview, setShowPreview] = useState(false);

  // --- Background Authentication ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Authentication Layer Error:", err);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  // --- Real-time Data Synchronization ---
  useEffect(() => {
    if (!user) return;
    const logsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'quality_logs');
    const q = query(logsCollection);

    const unsubscribe = onSnapshot(q, 
      (snapshot) => {
        const logs = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          timestamp: doc.data().timestamp?.toDate()?.toISOString() || new Date().toISOString()
        }));
        setErrorLog(logs);
      },
      (error) => console.error("Firestore Sync Failure:", error)
    );
    return () => unsubscribe();
  }, [user]);

  // --- Data Analysis Logic ---
  const handleFileUpload = async (e) => {
    const uploadedFile = e.target.files?.[0];
    if (!uploadedFile || !user) return;

    setFile(uploadedFile);
    setLoading(true);
    setActiveDiagnostics([]);
    setRemediationSummary(null);
    setShowPreview(false);

    try {
      const text = await uploadedFile.text();
      const lines = text.trim().split('\n');
      if (lines.length < 1) throw new Error("File corrupt");

      const headers = lines[0].split(',').map(h => h.trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const row = {};
        headers.forEach((header, idx) => { row[header] = values[idx] || ""; });
        rows.push(row);
      }

      setLastProcessedData({ headers, rows, filename: uploadedFile.name });

      const newErrors = [];
      const currentDiagnostics = [];

      headers.forEach(header => {
        const failingRows = [];
        rows.forEach((r, idx) => {
          const val = r[header];
          if (!val || val.trim() === '' || val.toLowerCase() === 'null' || val.toLowerCase() === 'na') {
            failingRows.push(idx + 2);
          }
        });

        if (failingRows.length > 0) {
          const errorDetail = {
            errorType: 'missing_value',
            column: header,
            dataset: uploadedFile.name,
            source: selectedSource,
            count: failingRows.length,
            totalRows: rows.length,
            failingIndices: failingRows.slice(0, 10),
            severity: failingRows.length / rows.length > 0.1 ? 'high' : 'medium'
          };
          newErrors.push(errorDetail);
          currentDiagnostics.push(errorDetail);
        }
      });

      setActiveDiagnostics(currentDiagnostics);
      const logsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'quality_logs');
      for (const error of newErrors) {
        await addDoc(logsCollection, { ...error, timestamp: serverTimestamp(), uploadedBy: user.uid });
      }
    } catch (error) {
      console.error('Core Analysis Error:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleAutoFixAndDownload = () => {
    if (!lastProcessedData) return;
    setIsFixing(true);
    setTimeout(() => {
      const { headers, rows, filename } = lastProcessedData;
      const changes = [];
      const fixedRows = rows.map(row => {
        const newRow = { ...row };
        headers.forEach(h => {
          if (!newRow[h] || newRow[h].trim() === "" || newRow[h].toLowerCase() === "null" || newRow[h].toLowerCase() === "na") {
            newRow[h] = "REMEDIATED_NA"; 
            const colChange = changes.find(c => c.column === h);
            if (colChange) colChange.count++;
            else changes.push({ column: h, count: 1, rule: "Null-Normalization" });
          }
        });
        return newRow;
      });

      const csvContent = [headers.join(','), ...fixedRows.map(row => headers.map(h => `"${row[h]}"`).join(','))].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('href', url);
      a.setAttribute('download', `healed_${filename}`);
      document.body.appendChild(a); a.click(); document.body.removeChild(a);

      setIsFixing(false); setFixSuccess(true); setRemediationSummary(changes);
      setActiveDiagnostics([]); setShowPreview(false);
      setTimeout(() => setFixSuccess(false), 8000);
    }, 1500);
  };

  // --- Dashboard Analytics & Search Engine ---
  const stats = useMemo(() => {
    const repeatedMap = {};
    const teamStats = {};
    const sortedLogs = [...errorLog].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    sortedLogs.forEach(log => {
      const patternKey = `${log.source}|${log.column}|${log.errorType}`;
      if (!repeatedMap[patternKey]) {
        repeatedMap[patternKey] = { ...log, occurrences: [], uniqueDatasets: new Set() };
      }
      repeatedMap[patternKey].occurrences.push({ timestamp: log.timestamp, count: log.count, dataset: log.dataset });
      repeatedMap[patternKey].uniqueDatasets.add(log.dataset);
      
      if (!teamStats[log.source]) teamStats[log.source] = { name: log.source, totalIssues: 0, score: 100 };
      teamStats[log.source].totalIssues += 1;
    });

    // Filter by search query
    const searchFilter = (item) => {
      const query = searchQuery.toLowerCase();
      return (
        item.column?.toLowerCase().includes(query) || 
        item.source?.toLowerCase().includes(query) || 
        item.dataset?.toLowerCase().includes(query)
      );
    };

    const repeated = Object.values(repeatedMap)
      .filter(r => r.occurrences.length > 1)
      .filter(searchFilter);

    const teamRanking = Object.values(teamStats)
      .map(t => ({ ...t, score: Math.max(0, 100 - (t.totalIssues * 5)) }))
      .sort((a, b) => b.score - a.score)
      .filter(t => t.name.toLowerCase().includes(searchQuery.toLowerCase()));

    return {
      repeated,
      recentActivity: sortedLogs.slice(0, 10).filter(searchFilter),
      teamRanking,
      totalIssuesCount: errorLog.length
    };
  }, [errorLog, searchQuery]);

  const filteredRepeated = useMemo(() => {
    if (viewMode === 'sender') return stats.repeated.filter(r => r.source === selectedSource);
    return stats.repeated;
  }, [stats.repeated, viewMode, selectedSource]);

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-900">
      <header className="bg-white border-b border-slate-200 sticky top-0 z-10 px-6 py-4 flex items-center justify-between shadow-sm">
        <div className="flex items-center gap-3">
          <div className="bg-indigo-600 p-2 rounded-lg text-white"><ShieldAlert size={24} /></div>
          <div>
            <h1 className="text-xl font-bold tracking-tight">Sentinel</h1>
            <p className="text-[10px] text-slate-500 font-black uppercase tracking-widest">Remediation Engine</p>
          </div>
        </div>
        
        <div className="flex-1 max-w-md mx-8 hidden md:block">
          <div className="relative group">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors" size={16} />
            <input 
              type="text" 
              placeholder="Search patterns, teams, or columns..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full bg-slate-100 border-none rounded-xl py-2 pl-10 pr-4 text-sm focus:ring-2 focus:ring-indigo-500 transition-all"
            />
          </div>
        </div>

        <div className="flex items-center gap-4">
          <div className="flex bg-slate-100 p-1 rounded-xl">
            <button onClick={() => setViewMode('cleaner')} className={`px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${viewMode === 'cleaner' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-500'}`}>Clean</button>
            <button onClick={() => setViewMode('sender')} className={`px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${viewMode === 'sender' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-500'}`}>Sender View</button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto w-full p-6 lg:p-10 flex flex-col gap-8">
        <section className="flex flex-col md:flex-row md:items-end justify-between gap-6">
          <div>
            <h2 className="text-3xl font-extrabold text-slate-800">{viewMode === 'cleaner' ? 'Quality Analysis Portal' : 'Submission Dashboard'}</h2>
            <p className="text-slate-500 mt-1 italic">Identify gaps and review structural modifications before downloading fixed files.</p>
          </div>
          <div className="flex flex-col gap-2">
            <label className="text-xs font-bold text-slate-400 uppercase tracking-tighter">Active Source Stream</label>
            <select value={selectedSource} onChange={(e) => setSelectedSource(e.target.value)} className="bg-white border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-medium shadow-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
              {['BI Team A', 'BI Team B', 'Marketing Data Team', 'Sales Analytics Team'].map(t => <option key={t} value={t}>{t}</option>)}
            </select>
          </div>
        </section>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div className="lg:col-span-2 space-y-8">
            <div className="bg-white border border-slate-200 rounded-3xl p-8 shadow-sm">
              <div className="flex items-center justify-between mb-6">
                <div className="flex items-center gap-2">
                  <div className={`w-8 h-8 rounded-full flex items-center justify-center ${viewMode === 'cleaner' ? 'bg-indigo-50 text-indigo-600' : 'bg-emerald-50 text-emerald-600'}`}>
                    {viewMode === 'cleaner' ? <BarChart3 size={16} /> : <Send size={16} />}
                  </div>
                  <h3 className="font-bold text-slate-800">{viewMode === 'cleaner' ? 'Analyze Data' : 'Submit Data'}</h3>
                </div>
              </div>
              
              <label className={`group relative border-2 border-dashed rounded-2xl p-8 flex flex-col items-center justify-center cursor-pointer transition-all ${
                viewMode === 'cleaner' ? 'border-slate-200 hover:border-indigo-400 hover:bg-indigo-50/30' : 'border-slate-200 hover:border-emerald-400 hover:bg-emerald-50/30'
              }`}>
                <input type="file" accept=".csv" className="hidden" onChange={handleFileUpload} />
                <div className="bg-slate-50 p-4 rounded-2xl mb-4 group-hover:scale-110 transition-transform shadow-sm">
                  <Upload className={`text-slate-400 ${viewMode === 'cleaner' ? 'group-hover:text-indigo-600' : 'group-hover:text-emerald-600'}`} size={32} />
                </div>
                <p className="text-slate-700 font-semibold text-center">{file ? file.name : `Drop CSV for ${selectedSource}`}</p>
                {loading && (
                   <div className="absolute inset-0 bg-white/90 rounded-2xl flex flex-col items-center justify-center font-bold animate-pulse">
                     <span className="text-indigo-600">Profiling Integrity...</span>
                   </div>
                )}
              </label>

              {/* PREVIEW AREA */}
              {viewMode === 'cleaner' && showPreview && lastProcessedData && (
                <div className="mt-8 bg-indigo-900 text-white rounded-3xl p-6 shadow-2xl animate-in fade-in slide-in-from-bottom-4 duration-500">
                  <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                      <div className="bg-indigo-500 p-2 rounded-xl"><Eye size={20} /></div>
                      <h4 className="text-sm font-black uppercase tracking-widest">AI Remediation Preview</h4>
                    </div>
                    <button onClick={() => setShowPreview(false)} className="text-indigo-400 hover:text-white transition-colors"><X size={20}/></button>
                  </div>
                  <div className="bg-indigo-800/50 rounded-2xl overflow-hidden border border-indigo-700 mb-6">
                    <table className="w-full text-left text-[11px]">
                      <thead>
                        <tr className="bg-indigo-900/50 text-indigo-300 border-b border-indigo-700 uppercase tracking-tighter">
                          <th className="px-4 py-3 font-black">Row</th>
                          <th className="px-4 py-3 font-black">Column</th>
                          <th className="px-4 py-3 font-black">Current</th>
                          <th className="px-4 py-3 font-black text-center"><ArrowRightLeft size={12} className="mx-auto"/></th>
                          <th className="px-4 py-3 font-black text-indigo-400">Healed</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-indigo-700/50">
                        {activeDiagnostics.slice(0, 5).map((diag, i) => (
                          <tr key={i} className="hover:bg-indigo-700/30 transition-colors">
                            <td className="px-4 py-3 font-mono text-indigo-400">#{diag.failingIndices[0]}</td>
                            <td className="px-4 py-3 font-bold">{diag.column}</td>
                            <td className="px-4 py-3"><span className="bg-rose-500/20 text-rose-300 px-1.5 py-0.5 rounded italic">NULL</span></td>
                            <td className="px-4 py-3 text-center text-indigo-600 opacity-50">→</td>
                            <td className="px-4 py-3"><span className="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded font-black">REMEDIATED_NA</span></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2 text-[10px] text-indigo-300 italic"><ShieldCheck size={14} className="text-emerald-400"/> Logic: Schema Safeguard</div>
                    <button onClick={handleAutoFixAndDownload} disabled={isFixing} className="bg-emerald-500 hover:bg-emerald-400 text-white px-6 py-2.5 rounded-xl text-xs font-black shadow-lg transition-all flex items-center gap-2">
                      {isFixing ? <Clock size={14} className="animate-spin"/> : <Download size={14}/>} Commit & Download
                    </button>
                  </div>
                </div>
              )}

              {/* POST-DOWNLOAD SUMMARY */}
              {viewMode === 'cleaner' && remediationSummary && !showPreview && (
                <div className="mt-8 bg-emerald-50 border-2 border-emerald-100 rounded-3xl p-6">
                  <div className="flex items-center gap-2 mb-4">
                    <Sparkles size={18} className="text-emerald-600" />
                    <h4 className="text-sm font-black text-emerald-800 uppercase tracking-widest">Remediation Log</h4>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {remediationSummary.map((change, i) => (
                      <div key={i} className="flex items-center justify-between bg-white rounded-xl p-3 shadow-sm border border-emerald-50">
                        <span className="text-xs font-bold text-slate-700">{change.column}</span>
                        <span className="text-[10px] font-black text-emerald-600">{change.count} Points</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* DIAGNOSTICS */}
              {viewMode === 'cleaner' && activeDiagnostics.length > 0 && !showPreview && (
                <div className="mt-8 border-t border-slate-100 pt-6">
                  <div className="flex items-center justify-between mb-4">
                    <h4 className="text-sm font-bold text-slate-800 flex items-center gap-2"><ListFilter size={16} className="text-indigo-600" /> Integrity Profile</h4>
                    {!fixSuccess && (
                      <button onClick={() => setShowPreview(true)} className="flex items-center gap-2 px-6 py-2.5 rounded-xl text-xs font-black bg-indigo-600 text-white hover:bg-indigo-700 scale-105 transition-all shadow-lg"><Sparkles size={14}/> Preview AI Healing</button>
                    )}
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {activeDiagnostics.map((diag, i) => (
                      <div key={i} className="bg-slate-50 border border-slate-100 rounded-2xl p-4">
                        <div className="flex justify-between items-center mb-2">
                          <span className="text-xs font-bold text-slate-700">{diag.column}</span>
                          <span className="text-[10px] font-black px-2 py-0.5 rounded bg-rose-100 text-rose-600 uppercase tracking-tighter">{((diag.count / diag.totalRows) * 100).toFixed(1)}% Failure</span>
                        </div>
                        <p className="text-[10px] text-slate-500 mb-2 font-medium">Found <span className="font-bold text-slate-800">{diag.count}</span> gaps.</p>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* RECURRING PATTERNS */}
            <div className="space-y-4">
              <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                <AlertTriangle size={20} className="text-orange-500" />
                {viewMode === 'cleaner' ? 'Strategic Pattern Analysis' : 'My Recurring Quality Gaps'}
              </h3>
              {filteredRepeated.length === 0 ? (
                <div className="bg-white rounded-3xl p-12 text-center border border-slate-100 italic text-slate-400">
                  {searchQuery ? `No patterns match "${searchQuery}"` : "No systemic patterns detected yet."}
                </div>
              ) : (
                <div className="space-y-4">
                  {filteredRepeated.map((issue, idx) => (
                    <DetailedPatternCard key={idx} issue={issue} viewMode={viewMode} />
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* SIDEBAR */}
          <div className="space-y-8">
            <div className="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm">
              <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><History size={18} className="text-indigo-600" /> Event Stream</h3>
              <div className="space-y-4">
                {stats.recentActivity.length === 0 ? (
                  <p className="text-xs text-slate-400 italic font-medium">No results found.</p>
                ) : (
                  stats.recentActivity.map(log => (
                    <div key={log.id} className="flex gap-3 text-sm border-l-2 border-slate-100 pl-3 py-1">
                      <div className="flex-1">
                        <p className="font-bold text-slate-700 capitalize text-xs">{log.column.replace(/_/g,' ')} Gaps</p>
                        <p className="text-[9px] text-slate-400 uppercase font-black tracking-widest">{log.source}</p>
                      </div>
                      <span className="text-[9px] font-mono text-slate-400">{new Date(log.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                  ))
                )}
              </div>
            </div>

            {viewMode === 'cleaner' && (
              <div className="bg-slate-900 rounded-3xl p-6 text-white shadow-xl">
                <h3 className="font-bold mb-4 flex items-center gap-2 text-indigo-400"><Activity size={18} /> Source Health Score</h3>
                <div className="space-y-5">
                  {stats.teamRanking.length === 0 ? (
                    <p className="text-xs text-slate-500 italic">No teams match query.</p>
                  ) : (
                    stats.teamRanking.map((team, idx) => (
                      <div key={team.name} className="flex flex-col gap-1.5">
                        <div className="flex justify-between text-[11px] font-black uppercase tracking-wider">
                          <span className="text-slate-400">{team.name}</span>
                          <span className={team.score > 70 ? 'text-emerald-400' : 'text-rose-400'}>{team.score.toFixed(0)}%</span>
                        </div>
                        <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
                          <div className={`h-full transition-all duration-1000 ${team.score > 70 ? 'bg-emerald-500' : 'bg-rose-500'}`} style={{width: `${team.score}%`}} />
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      </main>
    </div>
  );
}

function DetailedPatternCard({ issue, viewMode }) {
  const [showFix, setShowFix] = useState(false);
  const insights = {
    missing_value: {
      diagnostic: "Pattern detected when parser encounters empty commas or string literals like 'null'.",
      impact: "Blocks mathematical aggregations and causes silent join drops.",
      remediation: "Update CSV export scripts to mandate these fields.",
      technicalLogic: "The engine scans for 'Null' signatures and normalizes them into a single constant."
    }
  };
  const context = insights[issue.errorType] || insights.missing_value;

  return (
    <div className="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm overflow-hidden transition-all hover:shadow-md">
      <div className="flex justify-between items-start mb-6">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-1">
            <h4 className="text-lg font-bold text-slate-800">{issue.column}</h4>
            <span className="bg-amber-100 text-amber-700 text-[10px] font-black px-2 py-0.5 rounded tracking-widest uppercase">Systemic Gap</span>
          </div>
          <p className="text-xs text-slate-400 font-bold uppercase tracking-tight">Source: {issue.source}</p>
        </div>
        <div className="text-right">
          <p className="text-2xl font-black text-slate-800">{issue.occurrences.length}</p>
          <p className="text-[10px] font-bold text-slate-400 uppercase">Incidents</p>
        </div>
      </div>
      <div className="space-y-6">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="bg-slate-50 p-5 rounded-2xl">
            <h5 className="text-[10px] font-black text-rose-600 uppercase tracking-widest mb-3 flex items-center gap-1"><ShieldAlert size={12}/> Diagnostic Detail</h5>
            <p className="text-xs text-slate-600 leading-relaxed font-medium">{context.diagnostic}</p>
          </div>
          <div className="bg-indigo-50 p-5 rounded-2xl">
            <h5 className="text-[10px] font-black text-indigo-600 uppercase tracking-widest mb-3 flex items-center gap-1"><TrendingUp size={12}/> Impact Analysis</h5>
            <p className="text-xs text-slate-600 leading-relaxed font-medium">{context.impact}</p>
          </div>
        </div>
      </div>
      <div className="flex items-center justify-between mt-6 pt-6 border-t border-slate-100">
        <div className="flex gap-2">
          {issue.occurrences.slice(0, 3).map((occ, i) => (
            <div key={i} className="text-[9px] bg-white border border-slate-200 px-3 py-1 rounded-full text-slate-500 font-bold uppercase tracking-tighter">
              {new Date(occ.timestamp).toLocaleDateString()} • {occ.count} Err
            </div>
          ))}
        </div>
        {viewMode === 'cleaner' && (
          <button onClick={() => setShowFix(!showFix)} className="text-indigo-600 text-xs font-bold flex items-center gap-2 hover:underline transition-all">
            <Eye size={14} /> {showFix ? 'Hide Logic' : 'AI Healing Logic'}
          </button>
        )}
      </div>
      {showFix && viewMode === 'cleaner' && (
        <div className="mt-4 pt-4 border-t border-slate-50 flex items-center justify-between bg-slate-900 rounded-2xl p-6 animate-in slide-in-from-top-2 duration-300 shadow-xl">
          <div className="flex items-center gap-4">
            <div className="p-3 bg-slate-800 text-indigo-400 rounded-xl shadow-inner"><Wand2 size={20}/></div>
            <div>
              <p className="text-[10px] font-black text-white uppercase tracking-widest mb-1">Standard Normalization Heuristic</p>
              <p className="text-xs text-slate-400 leading-relaxed max-w-lg">{context.technicalLogic}</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
